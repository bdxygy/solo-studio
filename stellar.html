<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stellar AI Dashboard</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        
        .sidebar-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            color: #cbd5e1; /* slate-300 */
            font-weight: 500;
            transition: background-color 0.2s, color 0.2s;
        }
        .sidebar-link:hover {
            background-color: #334155; /* slate-700 */
            color: #ffffff;
        }
        .sidebar-link.active {
            background-color: #4f46e5; /* indigo-600 */
            color: #ffffff;
            font-weight: 600;
        }
        .sidebar-link i {
            margin-right: 0.75rem;
        }

        /* Custom styles for the image uploader and radio buttons */
        .image-uploader {
            border: 2px dashed #d1d5db;
            transition: border-color 0.3s, background-color 0.3s;
        }
        .image-uploader:hover {
            border-color: #4f46e5;
            background-color: #f0f2ff;
        }
        .ratio-radio:checked + label {
            border-color: #4f46e5;
            background-color: #e0e7ff;
            color: #4f46e5;
        }
        /* Simple spinner animation */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4f46e5;
            animation: spin 1s linear infinite;
        }
        /* Add a class to disable pointer events during generation */
        .generating {
            pointer-events: none;
            opacity: 0.7;
        }
        /* Language switcher style */
        .lang-btn.active {
            background-color: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }
    </style>
</head>
<body class="text-slate-800">

    <div class="flex h-screen bg-slate-100">
        <!-- Sidebar -->
        <aside class="hidden md:flex flex-col w-64 bg-slate-900 text-slate-100 p-4">
            <div class="flex items-center gap-3 h-16 px-2 mb-4">
                 <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-blue-500 rounded-lg flex items-center justify-center shadow-lg">
                    <i data-lucide="sparkles" class="text-white"></i>
                </div>
                <h1 class="text-xl font-bold" data-i18n="appTitle">Stellar AI</h1>
            </div>
            <nav class="flex flex-col gap-2">
                <a href="#" class="sidebar-link active">
                    <i data-lucide="image" class="w-5 h-5"></i>
                    <span data-i18n="menuBasic">Basic Product Photo</span>
                </a>
                 <a href="#" class="sidebar-link">
                    <i data-lucide="wand-2" class="w-5 h-5"></i>
                    <span data-i18n="menuAdvanced">Advanced Photoshoot</span>
                </a>
                <a href="#" class="sidebar-link">
                    <i data-lucide="shirt" class="w-5 h-5"></i>
                    <span data-i18n="menuVirtualTryOn">Virtual Try-On</span>
                </a>
                 <a href="#" class="sidebar-link">
                    <i data-lucide="user-round" class="w-5 h-5"></i>
                    <span data-i18n="menuAIModels">AI Models</span>
                </a>
            </nav>
            <div class="mt-auto">
                 <button id="settings-btn" class="sidebar-link mt-2 w-full">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                    <span data-i18n="menuSettings">Settings</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto">
            <header class="bg-white/80 backdrop-blur-md border-b border-slate-200 p-4 md:hidden">
                 <div class="flex items-center gap-3">
                     <div class="w-8 h-8 bg-gradient-to-br from-indigo-500 to-blue-500 rounded-lg flex items-center justify-center shadow-lg">
                        <i data-lucide="sparkles" class="text-white w-5 h-5"></i>
                    </div>
                    <h1 class="text-lg font-bold" data-i18n="appTitleMobile">Stellar AI</h1>
                </div>
            </header>

            <div class="p-6 md:p-8">
                <!-- AI Photo Generator Section -->
                <section id="basic-product-photo">
                    <div class="max-w-4xl mx-auto">
                         <div class="mb-8">
                            <h2 class="text-3xl font-bold text-slate-900" data-i18n="headerTitle">Basic Product Photo</h2>
                            <p class="text-slate-600 mt-1" data-i18n="headerDescription">Upload your product image and let our AI generate professional-quality photos in seconds.</p>
                        </div>

                        <div id="generator-ui" class="bg-white p-6 md:p-8 rounded-2xl shadow-lg flex flex-col gap-8">
                            <!-- Form Controls -->
                            <div class="space-y-6">
                                <div>
                                    <label class="font-semibold text-slate-700 block mb-2" data-i18n="step1Label">1. Upload Product Image</label>
                                    <div id="image-uploader" class="image-uploader rounded-lg p-6 text-center cursor-pointer">
                                        <input type="file" id="file-input" class="hidden" accept="image/*">
                                        <div id="image-preview-container" class="flex flex-col items-center justify-center text-slate-500">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                                            <p class="font-semibold" data-i18n="uploadHelpText">Click to upload</p>
                                            <p class="text-sm" data-i18n="uploadFileType">PNG, JPG, or WEBP</p>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <label for="photo-style" class="font-semibold text-slate-700 block mb-2" data-i18n="step2Label">2. Select Style of Photo</label>
                                    <select id="photo-style" class="w-full border border-gray-300 shadow-sm rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition"></select>
                                </div>
                                
                                <div>
                                    <label for="negative-prompt" class="font-semibold text-slate-700 block mb-2" data-i18n="step3LabelNegative">3. Negative Prompt (Optional)</label>
                                    <textarea id="negative-prompt" rows="2" class="w-full border border-gray-300 shadow-sm rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" data-i18n-placeholder="negativePromptPlaceholder" placeholder="e.g., text, watermarks, ugly, deformed..."></textarea>
                                </div>

                                <div>
                                    <label for="prompt" class="font-semibold text-slate-700 block mb-2" data-i18n="step4LabelPrompt">4. Write a Prompt</label>
                                    <div class="relative">
                                        <textarea id="prompt" rows="6" class="w-full border border-gray-300 shadow-sm rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" data-i18n-placeholder="promptPlaceholder" placeholder="e.g., A futuristic sneaker on a rocky planet at sunset..."></textarea>
                                        <button id="magic-prompt-btn" class="absolute bottom-2 right-2 bg-indigo-100 text-indigo-600 text-sm font-semibold px-3 py-1 rounded-md hover:bg-indigo-200 transition flex items-center">
                                           <span id="magic-prompt-text" data-i18n="magicPromptBtn">âœ¨ Magic Prompt</span>
                                           <div id="magic-prompt-spinner" class="spinner w-4 h-4 rounded-full ml-2 hidden"></div>
                                        </button>
                                    </div>
                                </div>

                                <div>
                                    <label class="font-semibold text-slate-700 block mb-2" data-i18n="step5LabelRatio">5. Select Photo Ratio</label>
                                    <div class="grid grid-cols-3 gap-2">
                                        <input type="radio" name="ratio" id="ratio-1-1" value="1:1" class="sr-only ratio-radio" checked>
                                        <label for="ratio-1-1" class="block border-2 border-slate-300 rounded-lg p-3 text-center cursor-pointer font-medium transition" data-i18n="ratioSquare">Square (1:1)</label>
                                        
                                        <input type="radio" name="ratio" id="ratio-4-5" value="4:5" class="sr-only ratio-radio">
                                        <label for="ratio-4-5" class="block border-2 border-slate-300 rounded-lg p-3 text-center cursor-pointer font-medium transition" data-i18n="ratioPortrait">Portrait (4:5)</label>

                                        <input type="radio" name="ratio" id="ratio-16-9" value="16:9" class="sr-only ratio-radio">
                                        <label for="ratio-16-9" class="block border-2 border-slate-300 rounded-lg p-3 text-center cursor-pointer font-medium transition" data-i18n="ratioWidescreen">Widescreen (16:9)</label>
                                    </div>
                                </div>
                                
                                <button id="generate-btn" class="w-full bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg text-lg hover:bg-indigo-700 transition-transform duration-300 hover:scale-105 shadow-lg flex items-center justify-center">
                                   <span id="generate-btn-text" data-i18n="generateBtn">Generate Photo</span>
                                   <div id="generate-btn-spinner" class="spinner w-6 h-6 rounded-full ml-3 hidden"></div>
                                </button>
                            </div>

                            <!-- Output Container -->
                            <div class="bg-slate-100 rounded-lg flex items-center justify-center p-4 border w-full min-h-[400px]">
                                <div id="output-container" class="text-center text-slate-500 w-full">
                                     <p class="font-semibold" data-i18n="outputPlaceholder">Your generated photo will appear here.</p>
                                </div>
                            </div>
                        </div>
                         <div id="error-box" class="hidden mt-4 max-w-4xl mx-auto bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative" role="alert">
                            <strong class="font-bold" data-i18n="errorTitle">Error:</strong>
                            <span class="block sm:inline" id="error-message">Something went wrong.</span>
                        </div>
                    </div>
                </section>
            </div>
             <!-- Mobile Bottom Navigation Placeholder -->
            <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 flex justify-around p-2 md:hidden">
                 <a href="#" class="flex flex-col items-center text-indigo-600">
                    <i data-lucide="image" class="w-6 h-6"></i>
                    <span class="text-xs font-medium" data-i18n="mobileMenuBasic">Basic</span>
                </a>
                 <a href="#" class="flex flex-col items-center text-slate-500">
                    <i data-lucide="wand-2" class="w-6 h-6"></i>
                    <span class="text-xs" data-i18n="mobileMenuAdvanced">Advanced</span>
                </a>
                 <a href="#" class="flex flex-col items-center text-slate-500">
                    <i data-lucide="shirt" class="w-6 h-6"></i>
                    <span class="text-xs" data-i18n="mobileMenuTryOn">Try-On</span>
                </a>
                <a href="#" class="flex flex-col items-center text-slate-500">
                    <i data-lucide="user-round" class="w-6 h-6"></i>
                    <span class="text-xs" data-i18n="mobileMenuModels">Models</span>
                </a>
            </div>
        </main>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-slate-900 bg-opacity-50 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-slate-800" data-i18n="settingsTitle">Settings</h3>
                <button id="close-modal-btn" class="text-slate-500 hover:text-slate-800">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div>
                <label class="font-semibold text-slate-700 block mb-2" data-i18n="languageLabel">Language</label>
                <div class="flex gap-2">
                    <button id="lang-en-modal" class="lang-btn w-full p-3 rounded-lg border-2 border-slate-200 font-semibold transition">English</button>
                    <button id="lang-id-modal" class="lang-btn w-full p-3 rounded-lg border-2 border-slate-200 text-slate-600 font-semibold transition">Indonesian</button>
                </div>
            </div>
        </div>
    </div>


    <script>
        // Initialize Lucide Icons
        lucide.createIcons();

        document.addEventListener('DOMContentLoaded', () => {
            // --- I18n Translation Setup ---
            const translations = {
                en: {
                    appTitle: "Stellar AI",
                    appTitleMobile: "Stellar AI",
                    menuBasic: "Basic Product Photo",
                    menuAdvanced: "Advanced Photoshoot",
                    menuVirtualTryOn: "Virtual Try-On",
                    menuAIModels: "AI Models",
                    menuSettings: "Settings",
                    settingsTitle: "Settings",
                    languageLabel: "Language",
                    headerTitle: "Basic Product Photo",
                    headerDescription: "Upload your product image and let our AI generate professional-quality photos in seconds.",
                    step1Label: "1. Upload Product Image",
                    uploadHelpText: "Click to upload",
                    uploadFileType: "PNG, JPG, or WEBP",
                    step2Label: "2. Select Style of Photo",
                    step3LabelNegative: "3. Negative Prompt (Optional)",
                    negativePromptPlaceholder: "e.g., text, watermarks, ugly, deformed...",
                    step4LabelPrompt: "4. Write a Prompt",
                    promptPlaceholder: "e.g., A futuristic sneaker on a rocky planet at sunset...",
                    magicPromptBtn: "âœ¨ Magic Prompt",
                    step5LabelRatio: "5. Select Photo Ratio",
                    ratioSquare: "Square (1:1)",
                    ratioPortrait: "Portrait (4:5)",
                    ratioWidescreen: "Widescreen (16:9)",
                    generateBtn: "Generate Photo",
                    outputPlaceholder: "Your generated photo will appear here.",
                    errorTitle: "Error:",
                    mobileMenuBasic: "Basic",
                    mobileMenuAdvanced: "Advanced",
                    mobileMenuTryOn: "Try-On",
                    mobileMenuModels: "Models",
                    errorNoImage: "Please upload a product image first.",
                    errorMagicPrompt: "Could not generate a magic prompt. Please try again.",
                    errorGeneration: "Failed to generate image. The model may have refused the request. Please try a different prompt or image.",
                    generatingStatus: "Generating your image...",
                    generatingTime: "This can take up to 30 seconds.",
                    generationFailed: "Generation failed. Please try again."
                },
                id: {
                    appTitle: "Stellar AI",
                    appTitleMobile: "Stellar AI",
                    menuBasic: "Foto Produk Dasar",
                    menuAdvanced: "Sesi Foto Lanjutan",
                    menuVirtualTryOn: "Coba Virtual",
                    menuAIModels: "Model AI",
                    menuSettings: "Pengaturan",
                    settingsTitle: "Pengaturan",
                    languageLabel: "Bahasa",
                    headerTitle: "Foto Produk Dasar",
                    headerDescription: "Unggah gambar produk Anda dan biarkan AI kami menghasilkan foto berkualitas profesional dalam hitungan detik.",
                    step1Label: "1. Unggah Gambar Produk",
                    uploadHelpText: "Klik untuk mengunggah",
                    uploadFileType: "PNG, JPG, atau WEBP",
                    step2Label: "2. Pilih Gaya Foto",
                    step3LabelNegative: "3. Prompt Negatif (Opsional)",
                    negativePromptPlaceholder: "cth., teks, watermark, jelek, cacat...",
                    step4LabelPrompt: "4. Tulis Prompt",
                    promptPlaceholder: "cth., Sepatu kets futuristik di planet berbatu saat matahari terbenam...",
                    magicPromptBtn: "âœ¨ Prompt Ajaib",
                    step5LabelRatio: "5. Pilih Rasio Foto",
                    ratioSquare: "Persegi (1:1)",
                    ratioPortrait: "Potret (4:5)",
                    ratioWidescreen: "Layar Lebar (16:9)",
                    generateBtn: "Hasilkan Foto",
                    outputPlaceholder: "Foto yang Anda hasilkan akan muncul di sini.",
                    errorTitle: "Kesalahan:",
                    mobileMenuBasic: "Dasar",
                    mobileMenuAdvanced: "Lanjutan",
                    mobileMenuTryOn: "Coba",
                    mobileMenuModels: "Model",
                    errorNoImage: "Harap unggah gambar produk terlebih dahulu.",
                    errorMagicPrompt: "Tidak dapat menghasilkan prompt ajaib. Silakan coba lagi.",
                    errorGeneration: "Gagal menghasilkan gambar. Model mungkin menolak permintaan. Coba prompt atau gambar yang berbeda.",
                    generatingStatus: "Menghasilkan gambar Anda...",
                    generatingTime: "Ini bisa memakan waktu hingga 30 detik.",
                    generationFailed: "Gagal menghasilkan. Silakan coba lagi."
                }
            };

            let currentLanguage = 'en';

            const langEnBtnModal = document.getElementById('lang-en-modal');
            const langIdBtnModal = document.getElementById('lang-id-modal');
            
            const settingsBtn = document.getElementById('settings-btn');
            const settingsModal = document.getElementById('settings-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');


            function setLanguage(lang) {
                currentLanguage = lang;
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    if (translations[lang][key]) {
                        el.innerText = translations[lang][key];
                    }
                });
                document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                     const key = el.getAttribute('data-i18n-placeholder');
                    if (translations[lang][key]) {
                        el.placeholder = translations[lang][key];
                    }
                });

                // Update language button styles in modal
                if (lang === 'en') {
                    langEnBtnModal.classList.add('active');
                    langEnBtnModal.classList.remove('bg-slate-100', 'text-slate-600');
                    langIdBtnModal.classList.remove('active');
                    langIdBtnModal.classList.add('bg-slate-100', 'text-slate-600');
                } else if (lang === 'id') {
                    langIdBtnModal.classList.add('active');
                    langIdBtnModal.classList.remove('bg-slate-100', 'text-slate-600');
                    langEnBtnModal.classList.remove('active');
                    langEnBtnModal.classList.add('bg-slate-100', 'text-slate-600');
                }
            }
            
            langEnBtnModal.addEventListener('click', () => {
                setLanguage('en');
                // settingsModal.classList.add('hidden');
            });
            langIdBtnModal.addEventListener('click', () => {
                setLanguage('id');
                // settingsModal.classList.add('hidden');
            });

            // --- Modal Logic ---
            settingsBtn.addEventListener('click', () => {
                settingsModal.classList.remove('hidden');
            });

            closeModalBtn.addEventListener('click', () => {
                settingsModal.classList.add('hidden');
            });

            settingsModal.addEventListener('click', (e) => {
                if (e.target === settingsModal) {
                    settingsModal.classList.add('hidden');
                }
            });


            // --- Element References ---
            const generatorUI = document.getElementById('generator-ui');
            const imageUploader = document.getElementById('image-uploader');
            const fileInput = document.getElementById('file-input');
            const imagePreviewContainer = document.getElementById('image-preview-container');
            const photoStyleSelect = document.getElementById('photo-style');
            const negativePromptInput = document.getElementById('negative-prompt');
            const promptInput = document.getElementById('prompt');
            const magicPromptBtn = document.getElementById('magic-prompt-btn');
            const magicPromptText = document.getElementById('magic-prompt-text');
            const magicPromptSpinner = document.getElementById('magic-prompt-spinner');
            const generateBtn = document.getElementById('generate-btn');
            const generateBtnText = document.getElementById('generate-btn-text');
            const generateBtnSpinner = document.getElementById('generate-btn-spinner');
            const outputContainer = document.getElementById('output-container');
            const errorBox = document.getElementById('error-box');
            const errorMessage = document.getElementById('error-message');

            const apiKey = ""; // API key will be injected by the environment.
            
            let uploadedFile = null;

            // --- Photo Styles ---
            const photoStyles = [
                "Splash Action", "Luxury Dark & Moody", "Minimalist Flat Lay", "Dynamic 45Â° View", "Natural & Organic",
                "Cinematic Product Shot", "Geometric & Abstract", "Industrial & Gritty", "Pastel & Soft", "High-Tech & Futuristic",
                "Vintage & Retro", "Surreal & Dreamy", "Hero Shot on Pedestal", "Product in Nature", "Monochromatic Scheme",
                "High-Contrast B&W", "Deconstructed / Exploded View", "Lifestyle In-Context", "Studio Shot with Color Gels", "Textured Background",
                "Floating / Zero Gravity", "Reflective Surface", "Close-up Macro Detail", "Symmetrical Arrangement", "Asymmetrical Balance",
                "Product with Smoke/Fog", "Neon & Cyberpunk", "Bohemian & Earthy", "Clean & Clinical", "Playful & Colorful",
                "Hand-held Product Shot", "Architectural Background", "Minimalist with Single Shadow", "Cosmic & Galactic", "Underwater Effect",
                "Gourmet & Foodie Style", "Brutalist Concrete Setting", "Art Deco Elegance", "Product with Fabric Drapes", "Pop Art Style",
                "Steampunk Aesthetic", "Golden Hour Glow", "Product in Motion (Blur)", "Storytelling Scene", "Infographic Style",
                "Product with Botanical Elements", "Icy & Frosted Look", "Warm & Cozy Atmosphere", "Urban Street Style", "Paper Art & Craft"
            ];

            // Populate the dropdown
            photoStyles.sort().forEach(style => {
                const option = document.createElement('option');
                option.value = style;
                option.textContent = style;
                photoStyleSelect.appendChild(option);
            });

            // --- Event Listeners ---
            imageUploader.addEventListener('click', () => fileInput.click());

            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    uploadedFile = file;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        imagePreviewContainer.innerHTML = `<img src="${e.target.result}" alt="Product Preview" class="max-h-32 rounded-lg"/>`;
                    };
                    reader.readAsDataURL(file);
                }
            });

            magicPromptBtn.addEventListener('click', handleMagicPrompt);
            generateBtn.addEventListener('click', handleImageGeneration);

            // --- API Call Functions ---

            // A helper function to call the API with exponential backoff
            async function callApiWithRetries(url, payload, retries = 3, delay = 1000) {
                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        const responseText = await response.text();

                        if (!response.ok) {
                            let errorMessage = `HTTP error! status: ${response.status}`;
                            // Try to parse the response as JSON to get a more specific error message
                            try {
                                const errorJson = JSON.parse(responseText);
                                errorMessage = errorJson.error?.message || errorMessage;
                            } catch (e) {
                                // If parsing fails, the responseText might be HTML or plain text.
                                if (responseText && responseText.length < 500) {
                                    errorMessage = responseText;
                                }
                            }
                            throw new Error(errorMessage);
                        }
                        
                        // If the response is successful but empty, return null to avoid parsing errors.
                        if (!responseText) {
                           return null; 
                        }
                        
                        return JSON.parse(responseText);

                    } catch (error) {
                        console.error(`API call attempt ${i + 1} failed for URL ${url}. Error: ${error.message}`);
                        if (i === retries - 1) {
                            // After the last retry, re-throw the original error to be caught by the calling function.
                            throw error;
                        }
                        await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                    }
                }
            }


            async function handleMagicPrompt() {
                if (!uploadedFile) {
                    showError(translations[currentLanguage].errorNoImage);
                    return;
                }

                showLoadingState(magicPromptBtn, magicPromptText, magicPromptSpinner, translations[currentLanguage].magicPromptBtn, true);
                hideError();
                
                const selectedStyle = photoStyleSelect.value;
                const examplePrompt = `Professional studio product photography. The product is placed on a clean, reflective surface against a seamless, neutral-colored studio background. Analyze the main product and place a few thematically relevant, smaller objects or props around it to create an appealing composition. The lighting should be soft, multi-point studio lighting that eliminates harsh shadows and highlights the product's details and texture. The final image must be ultra-realistic, sharp, and high-resolution`;
                
                const instructionToModel = `You are a creative director for product photography. Your task is to generate a new, highly detailed photo shoot prompt that matches the style, format, and level of detail as the example provided below. 
                    
                    First, analyze the user's uploaded product image to understand its characteristics. Then, create a completely new and unique prompt for it, specifically tailored to the selected photography style: "${selectedStyle}".

                    This new prompt must be as descriptive and comprehensive as the example, detailing the background, lighting, composition, and placement of complementary elements. These details must be inspired by and consistent with both the uploaded product and the chosen style ("${selectedStyle}").

                    Do not just fill in the blanks of the example. Create a fresh concept. For example, if the product is a watch and the style is "Industrial & Gritty," describe a scene on a rusted metal surface with gears and dramatic shadows, not a scene with citrus fruits.

                    Respond ONLY with the final, complete, newly generated prompt.

                    ---
                    HERE IS AN EXAMPLE OF THE DESIRED STYLE AND FORMAT (your output should be similarly detailed but unique):
                    ${examplePrompt}
                    ---

                    Now, using the uploaded image and the chosen style ("${selectedStyle}"), generate a new, original prompt in that same detailed style.`;
                
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                try {
                    const base64Data = await fileToBase64(uploadedFile);
                    const payload = {
                        contents: [{
                            parts: [
                                { text: instructionToModel },
                                { inlineData: { mimeType: uploadedFile.type, data: base64Data } }
                            ]
                        }]
                    };

                    const result = await callApiWithRetries(apiUrl, payload);
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) {
                        promptInput.value = text.trim();
                        promptInput.rows = 8; // Expand textarea for longer prompt
                    } else {
                        throw new Error("Invalid response from API for magic prompt.");
                    }
                } catch (error) {
                    console.error("Magic Prompt Error:", error);
                    showError(translations[currentLanguage].errorMagicPrompt);
                } finally {
                    showLoadingState(magicPromptBtn, magicPromptText, magicPromptSpinner, translations[currentLanguage].magicPromptBtn, false);
                }
            }

            async function handleImageGeneration() {
                if (!uploadedFile) {
                    showError(translations[currentLanguage].errorNoImage);
                    return;
                }
                
                showLoadingState(generateBtn, generateBtnText, generateBtnSpinner, translations[currentLanguage].generateBtn, true, true);
                hideError();

                outputContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full">
                        <div class="spinner w-12 h-12 rounded-full mb-4"></div>
                        <p class="font-semibold text-slate-600">${translations[currentLanguage].generatingStatus}</p>
                        <p class="text-sm text-slate-500">${translations[currentLanguage].generatingTime}</p>
                    </div>`;

                try {
                    const base64Data = await fileToBase64(uploadedFile);
                    const userPrompt = promptInput.value || "A professional product photo on a clean, white background.";
                    const negativePrompt = negativePromptInput.value.trim();
                    const selectedRatio = document.querySelector('input[name="ratio"]:checked').value;
                    
                    let finalPrompt = `${userPrompt} The final image must have an aspect ratio of ${selectedRatio}.`;
                    if (negativePrompt) {
                        finalPrompt += ` Strictly avoid the following elements in the image: ${negativePrompt}.`;
                    }
                    
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;
                    const payload = {
                        contents: [{
                            parts: [
                                { text: finalPrompt },
                                { inlineData: { mimeType: uploadedFile.type, data: base64Data } }
                            ]
                        }],
                        generationConfig: {
                            responseModalities: ['IMAGE']
                        }
                    };
                    
                    const result = await callApiWithRetries(apiUrl, payload);
                    const generatedImageData = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                    if (generatedImageData) {
                        const imageUrl = `data:image/png;base64,${generatedImageData}`;
                        outputContainer.innerHTML = `<img src="${imageUrl}" alt="Generated product photo" class="w-full h-auto object-contain rounded-lg"/>`;
                    } else {
                        throw new Error("No image data found in the API response.");
                    }

                } catch (error) {
                    console.error("Image Generation Error:", error);
                    showError(error.message || translations[currentLanguage].errorGeneration);
                    outputContainer.innerHTML = `<p class="font-semibold">${translations[currentLanguage].generationFailed}</p>`;
                } finally {
                    showLoadingState(generateBtn, generateBtnText, generateBtnSpinner, translations[currentLanguage].generateBtn, false, true);
                }
            }
            
            // --- UI Helper Functions ---
            
            function showLoadingState(button, textElement, spinnerElement, defaultText, isLoading, isMainGenerator = false) {
                button.disabled = isLoading;
                if (isLoading) {
                    textElement.textContent = isMainGenerator ? translations[currentLanguage].generateBtn.replace('...', '') : '';
                    spinnerElement.classList.remove('hidden');
                    if (isMainGenerator) generatorUI.classList.add('generating');
                } else {
                    textElement.textContent = defaultText;
                    spinnerElement.classList.add('hidden');
                     if (isMainGenerator) generatorUI.classList.remove('generating');
                }
            }

            function showError(message) {
                errorMessage.textContent = message;
                errorBox.classList.remove('hidden');
            }

            function hideError() {
                errorBox.classList.add('hidden');
            }

            function fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => {
                        // Return only the base64 part
                        resolve(reader.result.split(',')[1]);
                    };
                    reader.onerror = error => reject(error);
                });
            }

            // Initialize the app with the default language
            setLanguage(currentLanguage);

        });
    </script>
</body>
</html>


